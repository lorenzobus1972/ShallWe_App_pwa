<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShallWe!? — Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="firebase.js"></script>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <a class="logo" href="index.html" aria-label="Home">
        <svg viewBox="0 0 24 24"><path d="M8 19l2-6 2 2v5h2v-6l2-2 3 2v-3l-3-2-4 1-2-3-2 1 1 3-3 8h2z"/></svg>
      </a>
      <div class="appname" style="flex:1;text-align:center;">ShallWe!? — Admin</div>
      <div class="row">
        <a class="btn tiny gray" href="index.html">Home</a>
        <a id="peopleLink" class="btn tiny gray hidden" href="people.html">People</a>
        <button id="signout" class="btn tiny">Sign out</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Login card (shown when not signed in or not the admin) -->
    <section id="loginCard" class="card">
      <h2 class="title">Admin sign-in</h2>
      <div class="grid two">
        <div><input id="email" class="input" type="email" placeholder="Email (admin)" required></div>
        <div><input id="password" class="input" type="password" placeholder="Password" required></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="signin" class="btn">Sign in</button>
      </div>
      <p class="muted">Enable Email/Password auth in Firebase and create your admin user.</p>
      <p id="loginMsg" class="muted"></p>
    </section>

    <!-- Admin panel (only for ADMIN_UID) -->
    <section id="panel" class="card hidden">
      <div class="row" style="justify-content:space-between;">
        <h2 class="title">Current event</h2>
      </div>

      <div class="grid two">
        <div><label>Title<input id="evTitle" class="input" placeholder="Coffee & Walk — Newark"></label></div>
        <div><label>Place<input id="evPlace" class="input" placeholder="Newark"></label></div>
        <div><label>Date<input id="evDate" class="input" type="date"></label></div>
        <div><label>Time<input id="evTime" class="input" type="time"></label></div>
        <div><label>Location<input id="evLocation" class="input" placeholder="Newark"></label></div>
        <div><label>Description<textarea id="evDesc" class="input" rows="3" placeholder="Short description"></textarea></label></div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="loadCurrent" class="btn tiny gray">Load current</button>
        <button id="saveCurrent" class="btn tiny">Save current</button>
        <button id="archiveNow" class="btn tiny red">Archive now</button>
      </div>
      <p id="adminMsg" class="muted"></p>

      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">

      <h3 class="subtitle">Participants</h3>
      <div class="row" style="gap:12px;margin-bottom:8px;">
        <button id="loadFromPeople" class="btn tiny gray">Load from People</button>
        <button id="loadCurrentParticipants" class="btn tiny gray">Load current</button>
        <button id="addRow" class="btn tiny gray">Add name</button>
        <button id="saveParticipants" class="btn tiny">Save participants</button>
        <button id="copyToPeople" class="btn tiny gray">Copy current to People</button>
      </div>

      <table id="ptable" style="width:100%;border-collapse:collapse">
        <thead>
          <tr><th>Name</th><th>Status</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="msg" class="muted"></p>
    </section>

    <div class="footer">© 2025 ShallWe!?</div>
  </main>

  <script type="module">
    import {
      auth, getCurrentEvent, emailSignIn, emailSignOut,
      saveCurrentEvent, listPeople, upsertPeople,
      loadCurrentParticipants, saveCurrentParticipants,
      archiveCurrentEventNow, ADMIN_UID
    } from './firebase.js';

    // Elements
    const peopleLink = document.getElementById('peopleLink');
    const loginCard  = document.getElementById('loginCard');
    const panel      = document.getElementById('panel');
    const adminMsg   = document.getElementById('adminMsg');
    const loginMsg   = document.getElementById('loginMsg');
    const msg        = document.getElementById('msg');

    // Helpers to toggle UI
    function showLogin(note) {
      if (note) loginMsg.textContent = note; else loginMsg.textContent = '';
      loginCard.classList.remove('hidden');
      panel.classList.add('hidden');
      peopleLink.classList.add('hidden');
    }
    function showAdmin() {
      loginMsg.textContent = '';
      loginCard.classList.add('hidden');
      panel.classList.remove('hidden');
      peopleLink.classList.remove('hidden');
    }

    // Auth state drives the UI (persisted across reloads)
    auth.onAuthStateChanged(user => {
      if (!user) {
        showLogin();
        return;
      }
      if (user.uid === ADMIN_UID) {
        showAdmin();
      } else {
        showLogin("You're signed in but not authorized for Admin.");
      }
    });

    // Sign in/out handlers (let onAuthStateChanged control the UI)
    document.getElementById('signin').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      loginMsg.textContent = '';
      try {
        await emailSignIn(email, password);
        // UI will switch via onAuthStateChanged
      } catch (e) {
        loginMsg.textContent = e.message;
      }
    });

    document.getElementById('signout').addEventListener('click', async () => {
      await emailSignOut();
      // UI will switch via onAuthStateChanged
    });

    // Form fields
    const f = {
      title:    document.getElementById('evTitle'),
      place:    document.getElementById('evPlace'),
      date:     document.getElementById('evDate'),
      time:     document.getElementById('evTime'),
      location: document.getElementById('evLocation'),
      desc:     document.getElementById('evDesc')
    };

    // Participants table
    const tbody = document.querySelector('#ptable tbody');
    function addRow(name='', status='maybe') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input" value="${name}"></td>
        <td>
          <select class="input">
            <option value="going" ${status==='going'?'selected':''}>going</option>
            <option value="not_going" ${status==='not_going'?'selected':''}>not_going</option>
            <option value="maybe" ${status==='maybe'?'selected':''}>maybe</option>
          </select>
        </td>
        <td><button class="btn tiny red" type="button">Remove</button></td>`;
      tr.querySelector('button').addEventListener('click', () => tr.remove());
      tbody.appendChild(tr);
    }
    function readRows() {
      const rows = [];
      tbody.querySelectorAll('tr').forEach(tr => {
        const name = tr.querySelector('td:nth-child(1) input').value.trim();
        const status = tr.querySelector('td:nth-child(2) select').value;
        if (name) rows.push({ name, status });
      });
      return rows;
    }

    // Buttons
    document.getElementById('loadCurrent').addEventListener('click', async () => {
      const ev = await getCurrentEvent();
      if (!ev) { adminMsg.textContent = 'No current event found.'; return; }
      f.title.value    = ev.title || '';
      f.place.value    = ev.place || ev.location || '';
      f.date.value     = ev.date || '';
      f.time.value     = ev.time || '';
      f.location.value = ev.location || ev.place || '';
      f.desc.value     = ev.description || '';
      adminMsg.textContent = 'Loaded current event.';
    });

    document.getElementById('saveCurrent').addEventListener('click', async () => {
      const data = {
        title: f.title.value.trim(),
        place: f.place.value.trim(),
        date:  f.date.value,
        time:  f.time.value,
        location: f.location.value.trim(),
        description: f.desc.value.trim()
      };
      if (!data.title || !data.date || !data.time) {
        adminMsg.textContent = 'Title, date, time are required.';
        return;
      }
      await saveCurrentEvent(data);
      adminMsg.textContent = 'Saved current event.';
    });

    document.getElementById('archiveNow').addEventListener('click', async () => {
      adminMsg.textContent = 'Archiving…';
      try {
        const res = await archiveCurrentEventNow();
        if (res.status === 'archived') {
          adminMsg.textContent = `Archived to Past events (id: ${res.pastId}).`;
          ['title','place','date','time','location','desc'].forEach(k => f[k].value = '');
        } else {
          adminMsg.textContent = res.status;
        }
      } catch (err) {
        adminMsg.textContent = 'Archive failed: ' + err.message;
      }
    });

    document.getElementById('loadFromPeople').addEventListener('click', async () => {
      tbody.innerHTML = '';
      const people = await listPeople();
      if (people.length === 0) { msg.textContent = 'No people in master list.'; return; }
      people.forEach(p => addRow(p.name, 'maybe'));
      msg.textContent = 'Loaded from People as "maybe".';
    });

    document.getElementById('loadCurrentParticipants').addEventListener('click', async () => {
      tbody.innerHTML = '';
      const parts = await loadCurrentParticipants();
      if (parts.length === 0) { msg.textContent = 'No participants on current event.'; return; }
      parts.forEach(p => addRow(p.name, p.status || 'maybe'));
      msg.textContent = 'Loaded current participants.';
    });

    document.getElementById('addRow').addEventListener('click', () => addRow());
    document.getElementById('saveParticipants').addEventListener('click', async () => {
      const list = readRows();
      await saveCurrentParticipants(list);
      msg.textContent = 'Participants saved.';
    });
    document.getElementById('copyToPeople').addEventListener('click', async () => {
      const list = readRows().map(r => r.name);
      await upsertPeople(list);
      msg.textContent = 'Participants copied to People.';
    });
  </script>
</body>
</html>
