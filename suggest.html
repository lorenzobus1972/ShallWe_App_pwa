<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ShallWe!? — Suggest an event</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="firebase.js?v=7"></script>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <a class="logo" href="index.html" aria-label="Home">
        <svg viewBox="0 0 24 24"><path d="M8 19l2-6 2 2v5h2v-6l2-2 3 2v-3l-3-2-4 1-2-3-2 1 1 3-3 8h2z"/></svg>
      </a>
      <div class="appname center">ShallWe!? — Suggest an event</div>
      <a class="menu-btn" href="index.html" aria-label="Back">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6 8 12l6 6 1.41-1.41L10.83 12z"/></svg>
      </a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <form id="form" class="grid">
        <input id="title" class="input" placeholder="Event title" required>
        <input id="place" class="input" placeholder="Place (e.g., Newark)" required>
        <input id="date" class="input" type="date" required placeholder="Date">
        <input id="time" class="input" type="time" required placeholder="Event time">
        <textarea id="desc" class="input" rows="4" placeholder="Brief description"></textarea>
        <div class="row justify-end mt-10">
          <button type="submit" class="btn">Submit suggestion</button>
        </div>
      </form>
      <p id="msg" class="muted"></p>
    </section>

    <section class="card" id="sugs">
      <h3 class="subtitle">Recent suggestions</h3>
      <div id="sList"></div>
    </section>
  </main>

  <script type="module">
    import { submitSuggestion, listenSuggestions, deleteSuggestion, auth, ADMIN_UID } from './firebase.js?v=7';

    const form = document.getElementById('form');
    const msg = document.getElementById('msg');
    const sList = document.getElementById('sList');
    let isAdmin = false;

    auth.onAuthStateChanged(u => { isAdmin = !!(u && u.uid === ADMIN_UID); });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try {
        const payload = {
          title: form.title.value.trim(),
          place: form.place.value.trim(),
          date: form.date.value,
          time: form.time.value,
          description: form.desc.value.trim()
        };
        await submitSuggestion(payload);
        msg.textContent = "Thanks! Suggestion submitted.";
        form.reset();
      } catch(err) {
        msg.textContent = "Submit failed: " + err.message;
      }
    });

    function fmt(dt){
      try{
        const d = dt?.toDate ? dt.toDate() : (dt instanceof Date ? dt : new Date(dt));
        return new Intl.DateTimeFormat('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}).format(d);
      }catch{ return '' }
    }

    listenSuggestions(items => {
      sList.innerHTML = '';
      if (!items.length) {
        sList.innerHTML = '<p class="muted">No suggestions yet.</p>';
        return;
      }
      items.forEach(s => {
        const el = document.createElement('div');
        el.className = 'item';
        const h = document.createElement('div');
        h.className = 'row justify-between';
        h.innerHTML = `<h4>${(s.title||'Untitled')}</h4>`;
        if (isAdmin) {
          const del = document.createElement('button');
          del.className = 'btn tiny red';
          del.textContent = 'Delete';
          del.addEventListener('click', async ()=>{
            if (confirm('Delete this suggestion?')) await deleteSuggestion(s.id);
          });
          h.appendChild(del);
        }
        el.appendChild(h);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${(s.place||'')} • ${(s.date||'')} ${(s.time||'')}`;
        el.appendChild(meta);

        const p = document.createElement('p');
        p.textContent = (s.description||'');
        el.appendChild(p);

        const when = document.createElement('div');
        when.className = 'meta';
        when.textContent = 'Submitted: ' + fmt(s.createdAt);
        el.appendChild(when);

        sList.appendChild(el);
      });
    });
  </script>
</body>
</html>
