<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ShallWe!? — Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="firebase.js?v=7"></script>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <a class="logo" href="index.html" aria-label="Home"><svg viewBox="0 0 24 24"><path d="M8 19l2-6 2 2v5h2v-6l2-2 3 2v-3l-3-2-4 1-2-3-2 1 1 3-3 8h2z"/></svg></a>
      <div class="appname center">ShallWe!? — Chat</div>
      <a class="menu-btn" href="index.html" aria-label="Back">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </a>
    </div>
  </header>

  <main class="container">
    <section class="card chat-main">
      <div id="chat" class="chat-stream"></div>
      <form id="form" class="chat-form safe-bottom">
        <input id="name" type="text" class="input" placeholder="Your name (optional)">
        <input id="text" type="text" class="input" placeholder="Write a message…" required>
        <button type="submit" class="btn">Send</button>
      </form>
    </section>
  </main>

  <script type="module">
    import { ensureAnonAuth, listenMessages, sendMessage, auth } from './firebase.js?v=7';

    const chat = document.getElementById('chat');
    const form = document.getElementById('form');
    const nameInput = document.getElementById('name');
    const textInput = document.getElementById('text');

    function formatTime(d) {
      return new Intl.DateTimeFormat('en-GB', { hour:'2-digit', minute:'2-digit' }).format(d);
    }
    function escapeHtml(s) {
      return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function render(messages) {
      chat.innerHTML = '';
      const sorted = messages.slice().sort((a,b)=>{
        const ta = a.createdAt?.toMillis?.() ?? a.createdAtMillis ?? 0;
        const tb = b.createdAt?.toMillis?.() ?? b.createdAtMillis ?? 0;
        return ta - tb;
      });
      sorted.forEach(m => {
        const mine = (auth.currentUser && m.userId === auth.currentUser.uid);
        const div = document.createElement('div');
        div.className = 'msg ' + (mine ? 'me' : 'them');
        const date = m.createdAt?.toDate?.() || new Date(m.createdAtMillis || Date.now());
        div.innerHTML = `<div>${escapeHtml(m.text || '')}</div>
          <div class="meta">${escapeHtml(m.displayName || 'Anon')} • ${formatTime(date)}</div>`;
        chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    (async function init(){
      try { await ensureAnonAuth(); } catch (e) { alert(e.message); }

      listenMessages(items => render(items));

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = textInput.value.trim();
        if(!text) return;
        await sendMessage({
          text,
          userId: auth.currentUser?.uid || 'anon',
          displayName: nameInput.value.trim() || 'Anon'
        });
        textInput.value = '';
      });
    })();
  </script>
</body>
</html>
